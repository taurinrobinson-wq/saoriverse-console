name: Secret scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  detect-secrets:
    name: Detect secrets (allowlist aware)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          # Run a full scan and write JSON output
          detect-secrets scan --all-files --json > .secrets-found.json || true

      - name: Fail if new secrets found (respect .secret-allowlist)
        run: |
          python3 - <<'PY'
          import json,sys,fnmatch
          try:
              with open('.secret-allowlist') as f:
                  allow = [l.strip() for l in f if l.strip() and not l.startswith('#')]
          except FileNotFoundError:
              allow = []
          data = json.load(open('.secrets-found.json'))
          findings = []
          for filepath, items in data.get('results', {}).items():
              # if allowlist pattern matches, ignore
              if any(fnmatch.fnmatch(filepath, p) for p in allow):
                  continue
              if items:
                  findings.append((filepath, items))
          if findings:
              print('Secrets detected in the following files:')
              for f, items in findings:
                  print('-', f)
              print('\nIf these are allowed template/example files, add a matching glob to `.secret-allowlist`.')
              sys.exit(1)
          print('No new secrets detected.')
          PY
