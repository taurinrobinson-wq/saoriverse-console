---
name: Preprocessor unit tests (fast)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  preprocessor-tests:
    name: Run preprocessor unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest

      - name: Run focused preprocessor tests + taxonomy validator + prefs tests
        run: |
          # Run the focused preprocessor unit tests
          pytest -q tests/test_preprocessor.py
            # Run the user preferences test (mocked requests)
            # to ensure persistence helpers
          pytest -q tests/test_user_preferences.py
          # Run the taxonomy validator; this will be skipped when
          # no canonical taxonomy is present. It will fail the run if
          # a taxonomy exists and does not conform to the schema.
          pytest -q tests/test_taxonomy_validator.py
