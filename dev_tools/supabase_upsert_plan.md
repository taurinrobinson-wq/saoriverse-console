# Supabase backup & upsert plan (staged)

This directory contains scripts to create a full backup of the `glyphs` table from Supabase and a conservative, reviewable upsert plan built from the local cleaned export.

Files added:

- `supabase_backup_and_plan.py` — fetches the entire Supabase table (requires SUPABASE_URL and SUPABASE_KEY), writes a timestamped backup JSON/CSV, compares it with `dev_tools/cleaned_glyphs.json` and creates a staged upsert plan (JSON + inserts/updates CSVs). Dry-run by default.

- `supabase_upsert_runner.py` — consumes the plan or the CSVs and will perform batched upserts against Supabase when run with `--apply` and credentials. By default it prints a dry-run and shows sample payloads.

## Why this is safe

- The plan is generated locally and committed to your branch for review. No writes are performed unless you explicitly run the upsert runner with `--apply`.
- The upsert runner POSTs with `Prefer: resolution=merge-duplicates` and `on_conflict=<key>` (default `slug`). It posts in configurable batches (default 200) and stops on the first HTTP failure to avoid partial mass writes.
- You should use a Supabase *service-role* key for the backup and upsert operations (not an anon key). Keep that key secret and provide it via environment variables or Codespace secrets; do not commit it.

## Recommended workflow

1. Review the plan files generated by `supabase_backup_and_plan.py` (look for `dev_tools/supabase_upsert_plan_<ts>.json`, `*_inserts.csv`, `*_updates.csv`). Verify the counts and spot-check several records.

2. Run a dry-run of the upsert runner to inspect payload samples:

```bash

# dry-run (no network writes)
```sql
```sql
```

3. When you're satisfied, provide credentials and apply the upsert from a safe environment (Codespace or CI) where the service-role key is available as an environment variable. Example (Codespace or local):

```bash

export SUPABASE_URL=https://<your>.supabase.co
export SUPABASE_KEY=<your-service-role-key>

# apply in conservative batches
python3 dev_tools/supabase_upsert_runner.py --plan dev_tools/supabase_upsert_plan_<ts>.json --apply --batch-size 200

```

4. Monitor the output. The runner will stop on the first failing batch. If you see errors, fix the issues (often malformed JSON fields or constraint conflicts) and re-run the runner against the failing subset.

## Notes and troubleshooting

- If your Supabase instance enforces RLS or policies, ensure the service-role key is used or temporarily relax policies for the migration window.
- The scripts use the PostgREST REST API endpoints (`/rest/v1/<table>`). If your Supabase instance uses a custom path or proxy, adjust the `--supabase-url` argument accordingly.
- The scripts assume the canonical upsert key is `slug`. If you prefer another key (for example `id` or a composite key), pass `--key` to the backup script and `--on-conflict` to the runner.

## Security

- Never commit service-role keys. Use Codespace secrets or CI encrypted secrets.
- Keep a copy of the backup JSON/CSV off the system that has the keys (store in secure artifact storage if you need long-term retention).

If you want, I can run the backup now — provide SUPABASE_URL and SUPABASE_KEY in the Codespace secrets or tell me to skip and let you run it locally. I will not run the upsert until you explicitly give the go-ahead.
